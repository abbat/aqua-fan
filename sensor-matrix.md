# Выбор датчиков

Критерий - удержание температуры воды без резких перепадов (например, 24°C ± 1°C в час). При этом по низкой стороне должен включаться обогреватель удерживающий температуру в нижнем диапазоне, а по высокой вентиляторы уже должны работать на 100% удерживая температуру в верхнем диапазоне. Поскольку одновременная работа обогревателя и вентиляторов является нецелесообразной, необходим диапазон температур, когда вентиляторы уже отключились, но нагреватель еще не включился и в обратную сторону. Поскольку большинство современных обогревателей (например, [EHEIM thermocontrol](https://eheim.com/en_GB/aquatics/technology/aquarium-heaters/thermocontrol-e/thermocontrol-e-100)) имеет точность ±0.5°C, то оптимальным режимом работы датчика будет 25°C ± 0.5°C.

Датчики с внешним креплением на стекло не рассматриваются по причине того, что при большой разнице температур (например, летом) им требуется хорошая теплоизоляция от внешней среды - корпус получится достаточно громоздким и не эстетичным.

Аналоговые датчики не рассматриваются по причине того, что в большинстве случаев они имеют более высокую погрешность и требуют самостоятельной упаковки в водонепроницаемую гильзу (т.е. дополнительный "колхоз").

Т.о. на рынке представлено по сути только два датчика для измерения температуры воды:

* `DS18B20` - погрешность ±0.5°C, разрешение 0.5°C - 0.0625°C (9-12 bit);
* `GY-906` (`MLX90614ESF-XXX`), разрешение 0.02°C:
  * `BAA` - погрешность ±0.5°C (single zone, 90° FOV);
  * `BCC` - погрешность ±0.5°C (gradient compensated, 35° FOV);
  * `DCI` - погрешность ±0.2°C (gradient compensated, 5° FOV).

## GY-906

Огромным достоинством датчика `GY-906` является то, что он не требует погружения в воду и может быть смонтирован прямо в корпусе с вентиляторами. Однако, точность показаний данного датчика очень сильно зависит от градиентов температур (подробности см. ["Thermal/Mechanical design recommendations - IR products"](https://www.melexis.com/en/documents/documentation/application-notes/application-note-thermal-mechanical-design-recommendations-ir-products)).

<p align='center'>
<img src='https://user-images.githubusercontent.com/802583/176477094-f5bf7147-70e4-43d1-a71e-466fc770dcf4.jpg' alt='Инфракрасный датчик температуры GY-906 (MLX90614ESF)' title='Инфракрасный датчик температуры GY-906 (MLX90614ESF)'>
</p>

На экспериментальном стенде возмущающими воздействиями на показания `GY-906` оказались:

* рябь на поверхности воды от флейты фильтра и свободно плавающие растения;
* излучение LED ламп под крышкой;
* градиенты температур и сильная рябь на поверхности воды при включенных вентиляторах.

Диаметр измеряемого пятна на расстоянии датчика в 5 см. от поверхности воды:

* `BAA` (90° FOV) ~ 10.0 см.;
* `BCC` (35° FOV) ~ 3.15 см.;
* `DCI` (5° FOV)  ~ 0.43 см.

Все датчики в разной степени будут захватывать отраженное тепло LED-ламп, которые находятся на расстоянии приблизительно 3 см. от зеркала воды и имеют угол рассеивания в 120° (+5.2 см. по габариту лампы).

Средняя и стандартная ошибки показаний откалиброванного датчика `DCI` (5° FOV) относительно `DS18B20` (взятого за эталон) на экспериментальном стенде за три месяца наблюдений (июль-сентябрь, ~400 тыс. значений) в различных условиях составляет:

* в идеальных условиях без ламп и вентиляторов: Δ = -0.05°C, σ = 0.12 (±0.36°C) - средняя ошибка меньше разрешения датчика `GY-906`;
* с лампами, но без вентиляторов: Δ = +0.59°C, σ = 0.10 (±0.30°C) - датчик `GY-906` завышает показания т.к. захватывает отраженное тепло LED-ламп.

Если посмотреть на распределение частот ошибки, то явно видно два пика при работающих и отключенных лампах:

<p align='center'>
<img src='https://user-images.githubusercontent.com/802583/193416302-1094a08d-c19b-4fe7-85d5-1e8db1934f38.png' alt='Ошибка показаний датчика MLX90614ESF относительно DS18B20 с включенными и отключенными лампами' title='Ошибка показаний датчика MLX90614ESF относительно DS18B20 с включенными и отключенными лампами'>
</p>

Третий левый пик в распределении частот ошибок наблюдался в сентябрьское межсезонье при температуре окружающего воздуха ниже базовой для аквариума, включенном нагревателе и очень высокой (более 50%) относительной влажности. С включением центрального отопления распределение ошибки вернулось к обычным значениям.

С работающими вентиляторами LED-лампы уже не оказывают значимого влияния на ошибку: Δ = -0.19°C, σ = 0.20 (±0.6°C) - при работающих вентиляторах зеркало воды охлаждается потоком воздуха и датчик `GY-906` занижает показания.

<p align='center'>
<img src='https://user-images.githubusercontent.com/802583/193419477-05bb6db1-d814-4b8c-9033-8a739bb2c6c4.png' alt='Ошибка показаний датчика MLX90614ESF относительно DS18B20 с включенными вентиляторами' title='Ошибка показаний датчика MLX90614ESF относительно DS18B20 с включенными вентиляторами'>
</p>

Так же представляет интерес динамика изменения ошибки во время переходного процесса после включения вентиляторов:

<p align='center'>
<img src='https://user-images.githubusercontent.com/802583/193423167-d99b82a1-4650-499b-9052-245b11cf4923.png' alt='Изменение ошибки показаний датчика MLX90614ESF относительно DS18B20 после включения вентиляторов' title='Изменение ошибки показаний датчика MLX90614ESF относительно DS18B20 после включения вентиляторов'>
</p>

Корпус датчика охлаждается медленнее (и неравномерно) в сравнении с зеркалом воды сразу после начала движения воздуха. В результате изменения градиентов температур наблюдается мгновенное изменение "сырого" значения ошибки, которое впоследствии догонит фильтр, призванный сглаживать шум показаний от ряби на поверхности воды и проплывающих под датчиком растений.

Аналогичные переходные процессы можно наблюдать и в момент остановки вентиляторов, только в зависимости от состояния LED-ламп мгновенное изменение сырого значения температуры будет отличаться на ошибку измерения отраженного тепла - от +0.2°C при отключенных лампах до +0.8°C при включенных (см. выше).

Ошибка на всем интервале наблюдений на экспериментальном стенде составляет: Δ = -0.07°C, σ = 0.29 (±0.87°C). На практике это означает, что при базовой температуре в аквариуме в 25°C реальная температура будет поддерживаться в диапазоне от 23°C (точка включения нагревателя 23.5°C с погрешностью ±0.5°C) до 26°C.

**Вывод**: использование датчика `GY-906` имеет смысл только из эстетических соображений. По всем остальным параметрам он уступает датчику `DS18B20`.

## DS18B20

Недорогой, хорошо зарекомендовавший себя датчик. Может продаваться как в металлических, так и в пластиковых гильзах (в исполнении `Sonoff` так же комплектуется 4-pin 3.5 мм. штекером). По некоторым отзывам металлические гильзы в воде быстро деградируют, да и выглядят менее эстетично нежели пластиковые. При этом исполнение в пластиковой гильзе тяжелее найти (возможное ключевое слово `Taidacent`) и они сильно дороже.

<p align='center'>
<img src='https://user-images.githubusercontent.com/802583/176454294-fe8db34e-dad3-4ecc-89b3-c7a3c1a94082.jpg' alt='Датчик температуры Taidacent DS18B20' title='Датчик температуры Taidacent DS18B20'>
<img src='https://user-images.githubusercontent.com/802583/176454288-ba2da170-ebb5-49fd-b607-00f94f304944.jpg' alt='Датчик температуры Sonoff DS18B20' title='Датчик температуры Sonoff DS18B20'>
</p>

[Калибровку датчика](https://www.kandrsmith.org/RJS/Misc/Thermometers/absolute_ds18b20.html) в домашних условиях можно провести по "тройной точке воды". Процедура приготовления "ледяной ванны" с погрешностью ±0.002°C подробно описана в [NIST Technical Note 1411, 'Reproducibility of the temperature of the ice point in routine measurements'](https://nvlpubs.nist.gov/nistpubs/Legacy/TN/nbstechnicalnote1411.pdf).

## Прочие

Скорость испарения воды в водоеме (а значит и понижение температуры) зависит от скорости ветра, влажности, разности температур, давления. С описанием различных моделей можно ознакомиться в "A critical review on equations employed for the calculation of the evaporation rate from free water surfaces", Ernani Sartori (журнал Solar Energy, Volume 68, Issue 1, January 2000, Pages 77-89).

Однако, данные модели используются на больших водоемах и интервалах времени. В условиях аквариума и суточных колебаний температур единственным статистически значимым фактором, влияющим на скорость изменения температуры воды, является скорость потока воздуха (обороты вентиляторов).

Дополнительно, поскольку корпус вентиляторов устанавливается на границе раздела сред (комнатной температуры и температуры воды в аквариуме, комнатной влажности и практически 100% влажности под крышкой), датчики внутри корпуса будут показывать некоторые промежуточные значения в зависимости от работы вентиляторов.

Т.о. использование дополнительных датчиков (влажности, температуры воздуха, давления) в качестве источника дополнительной информации для регулирования скорости работы вентиляторов является нецелесообразным (а при монтаже внутри корпуса вентиляторов еще и сложно интерпретируемым).

Тем не менее ПО поддерживает использование дополнительных внешних датчиков температуры, влажности, давления и освещения (см. [Программное обеспечение](software.md)).
